<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Test <Map></Map></title>
        <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
        <link href="https://api.mapbox.com/mapbox-gl-js/v2.7.0/mapbox-gl.css" rel="stylesheet">
        <script src="https://api.mapbox.com/mapbox-gl-js/v2.7.0/mapbox-gl.js"></script>
        <script src='https://d3js.org/d3.v7.min.js'></script>
        <script src="https://d3js.org/d3.v6.js"></script>
        <script src="https://unpkg.com/d3-simple-slider"></script>
        <script src="/require.js"></script>
        <script type="text/javascript" src="coordinates.js"></script>

        <style>
            body { margin: 0; padding: 0; }
            #map { position: absolute; top: 0; bottom: 0; height: 50%; width: 50%; }
            #slider {position: absolute; top: 50%; width: 50%;}
            #value {position: absolute; top: 55%;}
        </style>
    </head>
    <body>
        <div id="map"></div>
        <script>



            mapboxgl.accessToken = 'pk.eyJ1IjoiZWxsaW90dzY1IiwiYSI6ImNrbGk0amV4MTA5bHUycW5tN2JzM3J0bTIifQ.OGT4ltSNZ7vyd_yEUg8afQ';
            const map = new mapboxgl.Map({
            container: 'map', // container ID
            style: 'mapbox://styles/mapbox/streets-v11', // style URL
            center: [-3, 54], // starting position [lng, lat]
            zoom: 1 // starting zoom
            });

            function project(data) {
                return map.project(new mapboxgl.LngLat(data[0], data[1]));
            }


            var container = map.getCanvasContainer();
            var svg = d3
            .select(container)
            .append("svg")
            .attr("width", "100%")
            .attr("height", "100%")
            .style("position", "absolute")
            .style("z-index", 2);

            

            d3.csv('owid-covid-data.csv').then( function(data) {

                const monthGroup = {}

                const monthDates = {}

                for(i in data) {
                    var date = new Date(data[i].date)
                    var key = date.getUTCMonth() + " - " + date.getUTCFullYear()
                    if(!isNaN(date)) {
                        monthGroup[key] = [];
                        monthDates[key] = new Date(date.getUTCFullYear(), date.getUTCMonth());
                    }
                }

                for(i in data) {
                    var date = new Date(data[i].date)
                    var key = date.getUTCMonth() + " - " + date.getUTCFullYear()
                    if(!isNaN(date)) {
                        monthGroup[key].push(data[i]);
                    }
                    

                }



                const nonCountries = ["Europe", "European Union", "High income", "Lower mideel income", 
                                        "North America", "South America", "Africa", "Upper middle income",
                                        "World"]


                var month = monthGroup["6 - 2020"]

                function groupByCountry(data) {
                    const newGroups = data.reduce((groups, item) => {
                    const group = (groups[item.location] || []);
                    group.push(item);
                    groups[item.location] = group;
                    return groups;
                    }, {});

                    return newGroups;
                }

                


                var deaths = [];

                function sumDeaths(data) {

                    const deaths = [];

                    for(i in data) {
                
                        const countryInd = i;
                        const country = data[countryInd];
                        var total = 0;
                        for(d of country) {
                            const deaths = parseInt(d.new_deaths)
                            if(!isNaN(deaths)) {
                                total += deaths;
                            }
                        }
                        if(total > 100 && !nonCountries.includes(i)) {
                            const income = country[0].gdp_per_capita
                            deaths.push({country : i,
                                        deaths: total,
                                        gdp: +income})
                        }
                    }

                    return deaths;
                }

                // Create list of the total death rate of each country
                var allDeaths = sumDeaths(groupByCountry(data));

                var sortedDeaths = allDeaths.sort(function(a, b) {
                    return b.deaths - a.deaths;
                });

                console.log(sortedDeaths);

                let totalDeathsAndIncome = sortedDeaths.map((item, i) => Object.assign({}, item, coordinates[i]));

                const monthTest = groupByCountry(month);

                console.log(month);

                var deaths = sumDeaths(groupByCountry(month));

                let arr3 = deaths.map((item, i) => Object.assign({}, item, coordinates[i]));

                var color = d3.scaleSequential().domain([0,d3.max(deaths, function(d) { return +d.deaths})]).range(["white", "red"]);

                console.log("Keys: ", Object.keys(monthGroup));

                var dateTicks = Object.keys(monthGroup);

                var circles = svg
                .selectAll("circle")
                .data(arr3)
                .enter()
                .append("circle")
                .attr("r", function(d) {
                    return d.deaths / 800;
                })
                .style("fill", function(d) {
                    return color(d.deaths);
                });

                function render() {
                    circles
                    .attr("cx", function (d) {
                        var longLat = [+d.long, +d.lat];
                        return project(longLat).x;
                    })
                    .attr("cy", function (d) {
                        var longLat = [+d.long, +d.lat];
                        return project(longLat).y;
                    });
                }

                function updateCircle(data) {

                    var newColor = d3.scaleSequential().domain([0,d3.max(data, function(d) { return +d.deaths})]).range(["white", "red"]);

                    console.log("Tansition called");

                    console.log(data);

                    svg.selectAll("circle")
                        .data(data)
                        .transition()
                        .duration(500)
                        .attr("cx", function (d) {
                        var longLat = [+d.long, +d.lat];
                            return project(longLat).x;
                        })
                        .attr("cy", function (d) {
                            var longLat = [+d.long, +d.lat];
                            return project(longLat).y;
                        })
                        .attr("r", function(d) {
                            return d.deaths / 1000;
                        })
                        .attr("fill", function(d) {
                            return newColor(d.deaths);
                        });

                    render();
                };

                map.on("viewreset", render);
                map.on("move", render);
                map.on("moveend", render);
                render(); // Call once to render

                var sliderBox = document.querySelector("#slider")

                var sliderWidth = sliderBox.offsetWidth;

                console.log(sliderWidth);

                var slider = d3
                    .sliderBottom()
                    .min(0)
                    .max(26)
                    .step(1)
                    .width(sliderWidth -120)
                    .displayValue(false)
                    .on('onchange', (val) => {
                        const month = dateTicks[val];

                        //const monthUpdate = groupByCountry(month);

                        console.log("Month: ", month);

                        var newMonthData = monthGroup[month];

                        var deathsUpdate = sumDeaths(groupByCountry(newMonthData));

                        let newData = deathsUpdate.map((item, i) => Object.assign({}, item, coordinates[i]));

                        updateCircle(newData);

                        d3.select('#value').text(month);
                    });

                d3.select('#slider')
                    .append('svg')
                    .attr('width', 500)
                    .attr('height', 100)
                    .append('g')
                    .attr('transform', 'translate(30,30)')
                    .call(slider);



            });
        </script>

        <p id="value"></p>
        <div id="slider"></div>
    
    </body>
</html>
