<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Test <Map></Map></title>
        <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
        <link href="https://api.mapbox.com/mapbox-gl-js/v2.7.0/mapbox-gl.css" rel="stylesheet">
        <script src="https://api.mapbox.com/mapbox-gl-js/v2.7.0/mapbox-gl.js"></script>
        <script src='https://d3js.org/d3.v7.min.js'></script>
        <style>
            body { margin: 0; padding: 0; }
            #map { position: absolute; top: 0; bottom: 0; height: 50%; width: 50%; }
        </style>
    </head>
    <body>
        <div id="map"></div>
        <script>
            mapboxgl.accessToken = 'pk.eyJ1IjoiZWxsaW90dzY1IiwiYSI6ImNrbGk0amV4MTA5bHUycW5tN2JzM3J0bTIifQ.OGT4ltSNZ7vyd_yEUg8afQ';
            const map = new mapboxgl.Map({
            container: 'map', // container ID
            style: 'mapbox://styles/mapbox/streets-v11', // style URL
            center: [-74.5, 40], // starting position [lng, lat]
            zoom: 9 // starting zoom
            });

            function project(data) {
                return map.project(new mapboxgl.LngLat(data[0], data[1]));
            }


            var container = map.getCanvasContainer();
            var svg = d3
            .select(container)
            .append("svg")
            .attr("width", "100%")
            .attr("height", "100%")
            .style("position", "absolute")
            .style("z-index", 2);

            var data = [
                [-74.5, 40.05],
                [-74.45, 40.0],
                [-74.55, 40.0],
                ];

            var dots = svg
                .selectAll("circle")
                .data(data)
                .enter()
                .append("circle")
                .attr("r", 20)
                .style("fill", "#ff0000");

            function render() {
                dots
                .attr("cx", function (d) {
                return project(d).x;
                })
                .attr("cy", function (d) {
                return project(d).y;
                });
            }

            map.on("viewreset", render);
            map.on("move", render);
            map.on("moveend", render);
            render(); // Call once to render

            var link = "https://api.mapbox.com/geocoding/v5/mapbox.places/United%20Kingdom.json?access_token=pk.eyJ1IjoiZWxsaW90dzY1IiwiYSI6ImNrbGk0amV4MTA5bHUycW5tN2JzM3J0bTIifQ.OGT4ltSNZ7vyd_yEUg8afQ"

            function httpGetAsync(URL, callback) {
                var xmlHttp = new XMLHttpRequest();
                xmlHttp.onreadystatechange = function() { 
                    if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
                        callback(xmlHttp.responseText);
                }
                xmlHttp.open("GET", URL, true); // true for asynchronous 
                xmlHttp.send(null);
            }

            function displayCoords(data) {
                return data;
            }

            //httpGetAsync(link, displayCoords);

            d3.csv('owid-covid-data.csv').then( function(data) {



                const monthGroup = {}

                const monthDates = {}

                for(i in data) {
                    //console.log(data[i]);
                    var date = new Date(data[i].date)
                    var key = date.getUTCMonth() + " - " + date.getUTCFullYear()
                    if(!isNaN(date)) {
                        monthGroup[key] = [];
                        monthDates[key] = new Date(date.getUTCFullYear(), date.getUTCMonth());
                    }
                }

                for(i in data) {
                    var date = new Date(data[i].date)
                    var key = date.getUTCMonth() + " - " + date.getUTCFullYear()
                    if(!isNaN(date)) {
                        monthGroup[key].push(data[i]);
                    }
                    

                }

                console.log(monthDates);

                console.log(monthGroup);

                /* 
                console.log(quartGroups); */




                const nonCountries = ["Europe", "European Union", "High income", "Lower mideel income", 
                                        "North America", "South America", "Africa", "Upper middle income",
                                        "World"]

                console.log("Monthgroup 0: ", monthGroup["0 - 2020"]);

                var month = monthGroup["6 - 2020"]

                function groupByCountry(data) {
                    const newGroups = data.reduce((groups, item) => {
                    const group = (groups[item.location] || []);
                    group.push(item);
                    groups[item.location] = group;
                    return groups;
                    }, {});

                    return newGroups;
                }

                function sumDeaths(data) {

                    const deaths = [];

                    for(i in data) {
                    const countryInd = i;
                    const country = data[countryInd];
                    const total = 0;
                    const url = urlBuilder(i);
                    httpGetAsync(URL, callback)
                    console.log("Country: ", url);
                    break;
                    for(d of country) {
                        const deaths = parseInt(d.new_deaths)
                        if(!isNaN(deaths)) {
                            total += deaths;
                        }
                    }
                    if(total > 100 && !nonCountries.includes(i)) {
                        deaths.push({country : i,
                                    deaths: total})
                    }
                    
                    }

                    return deaths;
                }

                var str = 'Bosnia'
                console.log("Split length", str.split(' '));

                function urlFormat(country) {
                    const stringArr = country.split(' ');
                    if(stringArr.length > 1) {
                        return stringArr.join("%20")
                    }
                    else {
                        return country;
                    }
                }

                function urlBuilder(country) {
                    var countryFormat = urlFormat(country);
                    var urlPrefix = "https://api.mapbox.com/geocoding/v5/mapbox.places/";
                    var accessToken = ".json?access_token=pk.eyJ1IjoiZWxsaW90dzY1IiwiYSI6ImNrbGk0amV4MTA5bHUycW5tN2JzM3J0bTIifQ.OGT4ltSNZ7vyd_yEUg8afQ";
                    return urlPrefix + countryFormat + accessToken;
                }

                console.log(urlBuilder(urlFormat('Bosnia and Herzegovina')))

                console.log(urlFormat('Bosnia'))

                console.log("New Deaths func: ", sumDeaths(groupByCountry(month)));

                var deaths = sumDeaths(groupByCountry(month));

                var sliderValues = Object.keys(monthGroup);

                console.log(sliderValues.length);


                var color = d3.scaleSequential().domain([0,d3.max(deaths, function(d) { return +d.deaths})]).interpolator(d3.interpolateTurbo);

                console.log(d3.max(deaths, function(d) { return +d.deaths}));





                });




        </script>
    
    </body>
</html>
