<!DOCTYPE html>
<html lang="en">

<head>
    <script src='https://d3js.org/d3.v7.min.js'></script>
</head>

<body>
    <script src="https://cdn.jsdelivr.net/npm/d3-selection@3"></script>
    <script src="https://unpkg.com/d3-simple-slider"></script>

    <style>
        
        .svg-container {
            display: inline-block;
            position: relative;
            width: 100%;
            height: 100%;
            padding-bottom: 100%; /* aspect ratio */
            vertical-align: top;
            overflow: hidden;
        }

        .responsive_svg {
            display: inline-block;
            position: absolute;
            top: 10px;
            left: 0;
        }

    </style>

    <div id="slider-container">
        <p id="value"></p>
        <div id="slider"></div>
    </div>


    <script>

        var svg = d3.select('body')
            .append('div')
            .classed('container', true)
            .append('svg')
            .attr('preserveAspectRatio', 'xMinYMin meet')
            .attr('viewBox', '0 0 600 200')
            .classed('responsive_svg', true);

/*         var sliderContainer = svg.append('div')
            .classed('slider-container', true)

        sliderContainer.append('p')
            .classed('value', true)

        sliderContainer.append('div')
            .classed('slider', true) */



            

        d3.csv('owid-covid-data.csv').then( function(data) {

            const groups = data.reduce((groups, item) => {
                const group = (groups[item.location] || []);
                group.push(item);
                groups[item.location] = group;
                return groups;
                }, {});

            const monthGroup = {}

            for(i in data) {
                //console.log(data[i]);
                var date = new Date(data[i].date)
                if(!isNaN(date)) {
                    monthGroup[date.getUTCMonth() + " - " + date.getUTCFullYear()] = [];
                }
            }

            for(i in data) {
                var date = new Date(data[i].date)
                var key = date.getUTCMonth() + " - " + date.getUTCFullYear()
                if(!isNaN(date)) {
                    monthGroup[key].push(data[i]);
                }
                

            }

            console.log(monthGroup)

/* 
            console.log(quartGroups); */


            const deaths = [];

            const nonCountries = ["Europe", "European Union", "High income", "Lower mideel income", 
                                    "North America", "South America", "Africa", "Upper middle income",
                                    "World"]

            for(i in monthGroup) {
                var country = i;
                var total = 0;
                for(d in monthGroup[i]) {
                    const deaths = parseInt(monthGroup[i][parseInt(d)].new_deaths)
                    if(!isNaN(deaths)) {
                        total += deaths;
                    }
                }
                if(total > 50000 && !nonCountries.includes(i)) {
                    deaths.push({country : i,
                                 deaths: total})
                }
                
            }

/*             for(i in groups) {
                var country = i;
                var total = 0;
                for(d in groups[i]) {
                    const deaths = parseInt(groups[i][parseInt(d)].new_deaths)
                    if(!isNaN(deaths)) {
                        total += deaths;
                    }
                }
                if(total > 50000 && !nonCountries.includes(i)) {
                    deaths.push({country : i,
                                 deaths: total})
                }
                
            } */

            console.log(deaths);

            var color = d3.scaleSequential().domain([0,d3.max(deaths, function(d) { return +d.deaths})]).interpolator(d3.interpolateTurbo);

            console.log(d3.max(deaths, function(d) { return +d.deaths}));

            var simulation = d3.forceSimulation(deaths)
                .force('charge', d3.forceManyBody().strength(5))
                .force('center', d3.forceCenter(150, 75))
                .force('collision', d3.forceCollide().radius(function(d) {
                    return d.deaths/50000
                }))
                .on('tick', ticked);

            function ticked() {
            var u = d3.select('svg')
                .selectAll('circle')
                .data(deaths)
                .join('circle')
                .attr('fill', function(d,i) {
                    return color(d.deaths);
                })
                .attr('r', function(d) {
                    return d.deaths/50000
                })
                .attr('cx', function(d) {
                    return d.x
                })
                .attr('cy', function(d) {
                    return d.y
                })
            }


            });

            var slider = d3
                .sliderHorizontal()
                .min(0)
                .max(36)
                .step(1)
                .width(100)
                .displayValue(false)
                .on('onchange', (val) => {
                d3.select('#value').text(val);
                });

            svg.call(slider);


    </script>
</body>

</html>
