<!DOCTYPE html>
<html lang="en">

<head>
    <script src='https://d3js.org/d3.v7.min.js'></script>
</head>

<body>
    <script src="https://cdn.jsdelivr.net/npm/d3-selection@3"></script>
    <script src="https://unpkg.com/d3-simple-slider"></script>

    <style>
        
        .svg-container {
            display: inline-block;
            position: relative;
            width: 100%;
            height: 100%;
            padding-bottom: 100%; /* aspect ratio */
            vertical-align: top;
            overflow: hidden;
        }

        .responsive_svg {
            display: inline-block;
            position: absolute;
            top: 10px;
            left: 0;
        }

    </style>

<!--     <div class="row align-items-center">
        <div class="col-sm-2"><p id="value-time"></p></div>
        <div class="col-sm"><div id="slider-time"></div></div>
    </div> -->


    <script>

        var svg = d3.select('body')
            .append('div')
            .classed('container', true)
            .append('svg')
            .attr('preserveAspectRatio', 'xMinYMin meet')
            .attr('viewBox', '0 0 600 200')
            .classed('responsive_svg', true);

/*         var sliderContainer = svg.append('div')
            .classed('slider-container', true)

        sliderContainer.append('p')
            .classed('value', true)

        sliderContainer.append('div')
            .classed('slider', true) */



            

        d3.csv('owid-covid-data.csv').then( function(data) {



            const monthGroup = {}

            const monthDates = {}

            for(i in data) {
                //console.log(data[i]);
                var date = new Date(data[i].date)
                var key = date.getUTCMonth() + " - " + date.getUTCFullYear()
                if(!isNaN(date)) {
                    monthGroup[key] = [];
                    monthDates[key] = new Date(date.getUTCFullYear(), date.getUTCMonth());
                }
            }

            for(i in data) {
                var date = new Date(data[i].date)
                var key = date.getUTCMonth() + " - " + date.getUTCFullYear()
                if(!isNaN(date)) {
                    monthGroup[key].push(data[i]);
                }
                

            }

            console.log(monthDates);

            console.log(monthGroup);

/* 
            console.log(quartGroups); */


            

            const nonCountries = ["Europe", "European Union", "High income", "Lower mideel income", 
                                    "North America", "South America", "Africa", "Upper middle income",
                                    "World"]

            console.log("Monthgroup 0: ", monthGroup["0 - 2020"]);

            var month = monthGroup["6 - 2020"]

            function groupByCountry(data) {
                const newGroups = data.reduce((groups, item) => {
                const group = (groups[item.location] || []);
                group.push(item);
                groups[item.location] = group;
                return groups;
                }, {});

                return newGroups;
            }

            function sumDeaths(data) {

                const deaths = [];

                for(i in data) {
                var countryInd = i;
                const country = data[countryInd];
                var total = 0;
                for(d of country) {
                    const deaths = parseInt(d.new_deaths)
                    if(!isNaN(deaths)) {
                        total += deaths;
                    }
                }
                if(total > 100 && !nonCountries.includes(i)) {
                    deaths.push({country : i,
                                 deaths: total})
                }
                
                }

                return deaths;
            }

            console.log("New Deaths func: ", sumDeaths(groupByCountry(month)));

            var deaths = sumDeaths(groupByCountry(month));

            var sliderValues = Object.keys(monthGroup);

            console.log(sliderValues.length);
            

            var color = d3.scaleSequential().domain([0,d3.max(deaths, function(d) { return +d.deaths})]).interpolator(d3.interpolateTurbo);

            console.log(d3.max(deaths, function(d) { return +d.deaths}));

/*             var simulation = d3.forceSimulation(deaths)
                .force('charge', d3.forceManyBody().strength(5))
                .force('center', d3.forceCenter(150, 75))
                .force('collision', d3.forceCollide().radius(function(d) {
                    return d.deaths/1000
                }))
                .on('tick', ticked);

            function ticked() {
            var u = d3.select('svg')
                .selectAll('circle')
                .data(deaths)
                .join('circle')
                .attr('fill', function(d,i) {
                    return color(d.deaths);
                })
                .attr('r', function(d) {
                    return d.deaths/1000
                })
                .attr('cx', function(d) {
                    return d.x
                })
                .attr('cy', function(d) {
                    return d.y
                })
            } */



                var sliderDates = Object.values(monthDates);

                var dataTime = d3.range(0, 10).map(function(d) {
                    return new Date(1995 + d, 10, 3);
                });

                var startValue = new Date(2020, 0);

                var slider = d3
                    .sliderBottom()
                    .min(d3.min(sliderDates))
                    .max(d3.max(sliderDates))
                    .step((1000 * 60 * 60 * 24 * 365)/12)
                    .width(400)
                    //.tickFormat(d3.timeFormat('%m'))
                    //.tickValues(sliderDates)
                    .displayValue(false)
                    .default(new Date(2020, 0))
                    .on('onchange', val => {
                        d3.select('p#value-time').text(d3.timeFormat('%m - %Y')(val));
                        
                        console.log(val);
                    });

                    d3.sliderBottom()

                    d3.select("g.axis")
                        .style("transform", "translate(100, 100");

            svg.call(slider);

            });








    </script>
</body>

</html>
